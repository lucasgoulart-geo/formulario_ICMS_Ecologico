<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICMS Ecol√≥gico 2025 - Inscri√ß√£o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bg-primary { background-color: #1d2d4e; }
        .text-primary { color: #1d2d4e; }
        .border-primary { border-color: #1d2d4e; }
        .bg-secondary { background-color: #d6d8de; }
    </style>
</head>
<body class="min-h-screen py-8 px-4" style="background: linear-gradient(to bottom right, #d6d8de, #ffffff);">
    
    <div id="app" class="max-w-2xl mx-auto bg-white rounded-lg shadow-xl p-8" style="border-top: 6px solid #1d2d4e;">
        <!-- Logo e Cabe√ßalho -->
        <div class="text-center mb-8">
            <div class="mb-4 flex justify-center">
                <img src="Logo_ICMS.png" alt="ICMS Ecol√≥gico Logo" class="h-32 object-contain">
            </div>
            <h1 class="text-3xl font-bold mb-2 text-primary">ICMS Ecol√≥gico - 2025</h1>
            <p class="text-gray-600 text-sm leading-relaxed">
                Formul√°rio para inscri√ß√£o no Evento de Premia√ß√£o da Gest√£o Ambiental Municipal - ICMS Ecol√≥gico 2025 - AF 2026.
            </p>
            <p class="text-gray-500 text-sm mt-2"><strong>Data:</strong> A confirmar</p>
            <p class="text-sm mt-3 font-medium text-primary">Cada munic√≠pio pode inscrever at√© 3 representantes</p>
        </div>

        <!-- Loading -->
        <div id="loading" class="text-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-900 mx-auto mb-4"></div>
            <p class="text-gray-600">Carregando formul√°rio...</p>
        </div>

        <!-- Mensagem de Sucesso -->
        <div id="successMessage" class="hidden mb-6 p-4 rounded-lg flex items-center gap-2" style="background-color: #e8f5e9; border: 1px solid #4caf50; color: #2e7d32;">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span>Inscri√ß√£o realizada com sucesso!</span>
        </div>

        <!-- Mensagem de Erro -->
        <div id="errorMessage" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-lg flex items-center gap-2 text-red-800">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span id="errorText"></span>
        </div>

        <!-- Formul√°rio -->
        <div id="formContainer" class="hidden space-y-6">
            <!-- Munic√≠pio -->
            <div>
                <label class="block text-sm font-semibold mb-2 text-primary">
                    Munic√≠pio <span class="text-red-500">*</span>
                </label>
                <select id="municipio" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:outline-none">
                    <option value="">Selecione o munic√≠pio</option>
                </select>
                <p id="errorMunicipio" class="hidden mt-1 text-sm text-red-500"></p>
            </div>

            <!-- Campos do Representante -->
            <div id="representanteFields" class="hidden">
                <div class="border-t pt-6 bg-secondary">
                    <h3 class="text-lg font-semibold mb-4 text-primary">Dados do Representante</h3>
                </div>

                <!-- Nome Completo -->
                <div>
                    <label class="block text-sm font-semibold mb-2 text-primary">
                        Nome Completo <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="nomeCompleto" placeholder="Ex: Maria Silva Santos" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:outline-none">
                    <p id="errorNome" class="hidden mt-1 text-sm text-red-500"></p>
                </div>

                <!-- Cargo -->
                <div>
                    <label class="block text-sm font-semibold mb-2 text-primary">
                        Cargo <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="cargo" placeholder="Ex: Prefeito" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:outline-none">
                    <p id="errorCargo" class="hidden mt-1 text-sm text-red-500"></p>
                </div>

                <!-- CPF -->
                <div>
                    <label class="block text-sm font-semibold mb-2 text-primary">
                        CPF <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="cpf" placeholder="000.000.000-00" maxlength="14"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:outline-none">
                    <p id="errorCpf" class="hidden mt-1 text-sm text-red-500"></p>
                </div>

                <!-- E-mail -->
                <div>
                    <label class="block text-sm font-semibold mb-2 text-primary">
                        E-mail <span class="text-red-500">*</span>
                    </label>
                    <input type="email" id="email" placeholder="seu.email@exemplo.com"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:outline-none">
                    <p id="errorEmail" class="hidden mt-1 text-sm text-red-500"></p>
                </div>

                <!-- Bot√£o -->
                <button id="submitBtn" class="w-full text-white font-semibold py-3 px-6 rounded-lg transition duration-200 bg-primary hover:opacity-90 disabled:opacity-50">
                    Realizar Inscri√ß√£o
                </button>
            </div>

            <!-- Aviso Munic√≠pio Cheio -->
            <div id="municipioFullWarning" class="hidden p-4 rounded-lg flex items-center gap-2" style="background-color: #fff3cd; border: 1px solid #ffc107; color: #856404;">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
                <span>Este munic√≠pio j√° atingiu o limite de 3 representantes cadastrados.</span>
            </div>
        </div>

        <!-- Aviso Final -->
        <div class="mt-6 p-4 rounded-lg bg-secondary">
            <p class="text-sm text-primary">
                <strong>Aten√ß√£o:</strong> Cada munic√≠pio pode cadastrar de 1 at√© 3 representantes. Os e-mails n√£o podem ser repetidos.
            </p>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxXFjhaOSHhEd3JgKrU1IDj2dGg_bWoiIeaLFBnkPsIyNRK6ACVUr5FQz9d7rcVd-7f/exec';
        
        const municipios = ["Angra dos Reis", "Aperib√©", "Araruama", "Areal", "Arma√ß√£o dos B√∫zios", "Arraial do Cabo", "Barra do Pira√≠", "Barra Mansa", "Belford Roxo", "Bom Jardim", "Bom Jesus do Itabapoana", "Cabo Frio", "Cachoeiras de Macacu", "Cambuci", "Carapebus", "Comendador Levy Gasparian", "Campos dos Goytacazes", "Cantagalo", "Cardoso Moreira", "Carmo", "Casimiro de Abreu", "Concei√ß√£o de Macabu", "Cordeiro", "Duas Barras", "Duque de Caxias", "Engenheiro Paulo de Frontin", "Guapimirim", "Iguaba Grande", "Itabora√≠", "Itagua√≠", "Italva", "Itaocara", "Itaperuna", "Itatiaia", "Japeri", "Laje do Muria√©", "Maca√©", "Macuco", "Mag√©", "Mangaratiba", "Maric√°", "Mendes", "Mesquita", "Miguel Pereira", "Miracema", "Natividade", "Nil√≥polis", "Niter√≥i", "Nova Friburgo", "Nova Igua√ßu", "Paracambi", "Para√≠ba do Sul", "Paraty", "Paty do Alferes", "Petr√≥polis", "Pinheiral", "Pira√≠", "Porci√∫ncula", "Porto Real", "Quatis", "Queimados", "Quissam√£", "Resende", "Rio Bonito", "Rio Claro", "Rio das Flores", "Rio das Ostras", "Rio de Janeiro", "Santa Maria Madalena", "Santo Ant√¥nio de P√°dua", "S√£o Francisco de Itabapoana", "S√£o Fid√©lis", "S√£o Gon√ßalo", "S√£o Jo√£o da Barra", "S√£o Jo√£o de Meriti", "S√£o Jos√© de Ub√°", "S√£o Jos√© do Vale do Rio Preto", "S√£o Pedro da Aldeia", "S√£o Sebasti√£o do Alto", "Sapucaia", "Saquarema", "Serop√©dica", "Silva Jardim", "Sumidouro", "Tangu√°", "Teres√≥polis", "Trajano de Moraes", "Tr√™s Rios", "Valen√ßa", "Varre-Sai", "Vassouras", "Volta Redonda"];
        
        let municipioData = {};
        let allEmails = [];

        // Carregar dados iniciais
        async function loadData() {
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                
                if (data.status === 'success') {
                    municipioData = data.municipios || {};
                    allEmails = data.emails || [];
                }
                
                populateMunicipios();
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('formContainer').classList.remove('hidden');
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showError('Erro ao carregar formul√°rio. Recarregue a p√°gina.');
            }
        }

        function populateMunicipios() {
            const select = document.getElementById('municipio');
            select.innerHTML = '<option value="">Selecione o munic√≠pio</option>';
            
            municipios.forEach(mun => {
                const option = document.createElement('option');
                const count = municipioData[mun]?.count || 0;
                const isFull = count >= 3;
                
                option.value = mun;
                option.textContent = `${mun} ${isFull ? 'üîí Vagas Preenchidas (3/3)' : count > 0 ? `(${count}/3)` : ''}`;
                option.disabled = isFull;
                select.appendChild(option);
            });
        }

        // Formata√ß√£o CPF
        document.getElementById('cpf').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            }
            e.target.value = value;
        });

        // Mostrar/ocultar campos ao selecionar munic√≠pio
        document.getElementById('municipio').addEventListener('change', function() {
            const municipio = this.value;
            const fields = document.getElementById('representanteFields');
            const warning = document.getElementById('municipioFullWarning');
            
            if (municipio) {
                const count = municipioData[municipio]?.count || 0;
                if (count >= 3) {
                    fields.classList.add('hidden');
                    warning.classList.remove('hidden');
                } else {
                    fields.classList.remove('hidden');
                    warning.classList.add('hidden');
                }
            } else {
                fields.classList.add('hidden');
                warning.classList.add('hidden');
            }
        });

        // Valida√ß√£o CPF
        function validateCPF(cpf) {
            const numbers = cpf.replace(/\D/g, '');
            if (numbers.length !== 11 || /^(\d)\1{10}$/.test(numbers)) return false;
            
            let sum = 0;
            for (let i = 0; i < 9; i++) sum += parseInt(numbers.charAt(i)) * (10 - i);
            let digit = 11 - (sum % 11);
            if (digit >= 10) digit = 0;
            if (digit !== parseInt(numbers.charAt(9))) return false;
            
            sum = 0;
            for (let i = 0; i < 10; i++) sum += parseInt(numbers.charAt(i)) * (11 - i);
            digit = 11 - (sum % 11);
            if (digit >= 10) digit = 0;
            return digit === parseInt(numbers.charAt(10));
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        function showSuccess() {
            const successDiv = document.getElementById('successMessage');
            successDiv.classList.remove('hidden');
            setTimeout(() => successDiv.classList.add('hidden'), 5000);
        }

        // Submit
        document.getElementById('submitBtn').addEventListener('click', async function() {
            // Limpar erros
            document.querySelectorAll('[id^="error"]').forEach(el => {
                el.classList.add('hidden');
                el.textContent = '';
            });

            const municipio = document.getElementById('municipio').value;
            const nomeCompleto = document.getElementById('nomeCompleto').value.trim();
            const cargo = document.getElementById('cargo').value.trim();
            const cpf = document.getElementById('cpf').value;
            const email = document.getElementById('email').value.trim();

            let hasError = false;

            if (!municipio) {
                document.getElementById('errorMunicipio').textContent = 'Selecione um munic√≠pio';
                document.getElementById('errorMunicipio').classList.remove('hidden');
                hasError = true;
            }

            if (!nomeCompleto) {
                document.getElementById('errorNome').textContent = 'Nome completo √© obrigat√≥rio';
                document.getElementById('errorNome').classList.remove('hidden');
                hasError = true;
            }

            if (!cargo) {
                document.getElementById('errorCargo').textContent = 'Cargo √© obrigat√≥rio';
                document.getElementById('errorCargo').classList.remove('hidden');
                hasError = true;
            }

            if (!validateCPF(cpf)) {
                document.getElementById('errorCpf').textContent = 'CPF inv√°lido';
                document.getElementById('errorCpf').classList.remove('hidden');
                hasError = true;
            }

            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                document.getElementById('errorEmail').textContent = 'E-mail inv√°lido';
                document.getElementById('errorEmail').classList.remove('hidden');
                hasError = true;
            }

            if (allEmails.includes(email.toLowerCase())) {
                document.getElementById('errorEmail').textContent = 'Este e-mail j√° foi cadastrado';
                document.getElementById('errorEmail').classList.remove('hidden');
                hasError = true;
            }

            if (hasError) return;

            // Enviar
            this.disabled = true;
            this.textContent = 'Enviando...';

            // Usar form submission com iframe para evitar CORS
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = SCRIPT_URL;
            form.target = 'hidden_iframe';
            
            const fields = { tipo: 'municipio', municipio, nomeCompleto, cargo, cpf, email };
            for (const [key, value] of Object.entries(fields)) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                form.appendChild(input);
            }
            
            document.body.appendChild(form);
            
            // Criar iframe oculto
            let iframe = document.getElementById('hidden_iframe');
            if (!iframe) {
                iframe = document.createElement('iframe');
                iframe.id = 'hidden_iframe';
                iframe.name = 'hidden_iframe';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
            }
            
            // Handler de sucesso
            iframe.onload = () => {
                showSuccess();
                document.getElementById('nomeCompleto').value = '';
                document.getElementById('cargo').value = '';
                document.getElementById('cpf').value = '';
                document.getElementById('email').value = '';
                document.getElementById('municipio').value = '';
                document.getElementById('representanteFields').classList.add('hidden');
                
                this.disabled = false;
                this.textContent = 'Realizar Inscri√ß√£o';
                
                form.remove();
                loadData();
            };
            
            form.submit();
        });

        // Inicializar
        loadData();
    </script>
</body>
</html>
