<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICMS Ecológico 2025 - Inscrição</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bg-primary { background-color: #1d2d4e; }
        .text-primary { color: #1d2d4e; }
        .border-primary { border-color: #1d2d4e; }
        .bg-secondary { background-color: #d6d8de; }
    </style>
</head>
<body class="min-h-screen py-8 px-4" style="background: linear-gradient(to bottom right, #d6d8de, #ffffff);">
    
    <div id="app" class="max-w-2xl mx-auto bg-white rounded-lg shadow-xl p-8" style="border-top: 6px solid #1d2d4e;">
        <!-- Logo e Cabeçalho -->
        <div class="text-center mb-8">
            <div class="mb-4 flex justify-center">
                <img src="Logo_ICMS.png" alt="ICMS Ecológico Logo" class="h-32 object-contain">
            </div>
            <h1 class="text-3xl font-bold mb-2 text-primary">ICMS Ecológico - 2025</h1>
            <p class="text-gray-600 text-sm leading-relaxed">
                Formulário para inscrição no Evento de Premiação da Gestão Ambiental Municipal - ICMS Ecológico 2025 - AF 2026.
            </p>
            <p class="text-gray-500 text-sm mt-2"><strong>Data:</strong> A confirmar</p>
        </div>

        <!-- Loading -->
        <div id="loading" class="text-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-900 mx-auto mb-4"></div>
            <p class="text-gray-600">Carregando formulário...</p>
        </div>

        <!-- Mensagem de Sucesso -->
        <div id="successMessage" class="hidden mb-6 p-4 rounded-lg flex items-center gap-2" style="background-color: #e8f5e9; border: 1px solid #4caf50; color: #2e7d32;">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span>Inscrição realizada com sucesso!</span>
        </div>

        <!-- Mensagem de Erro -->
        <div id="errorMessage" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-lg flex items-center gap-2 text-red-800">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span id="errorText"></span>
        </div>

        <!-- Formulário -->
        <div id="formContainer" class="hidden space-y-6">
            <!-- Instruções -->
            <div class="p-4 rounded-lg bg-blue-50 border border-blue-200">
                <p class="text-sm text-blue-800">
                    <strong>Atenção:</strong> Para representantes municipais, selecione o seu município de competência. Caso não represente município, selecione a opção <strong>"Instituição"</strong>.
                </p>
            </div>

            <!-- Município ou Instituição -->
            <div>
                <label class="block text-sm font-semibold mb-2 text-primary">
                    Município ou Instituição <span class="text-red-500">*</span>
                </label>
                <select id="municipio" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:outline-none">
                    <option value="">Selecione</option>
                    <option value="Instituição">Instituição</option>
                </select>
                <p id="errorMunicipio" class="hidden mt-1 text-sm text-red-500"></p>
            </div>

            <!-- Campo Instituição (aparece só quando seleciona "Instituição") -->
            <div id="campoInstituicao" class="hidden">
                <label class="block text-sm font-semibold mb-2 text-primary">
                    Nome da Instituição <span class="text-red-500">*</span>
                </label>
                <input type="text" id="nomeInstituicao" placeholder="Ex: Instituto Estadual do Ambiente - INEA" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:outline-none">
                <p id="errorInstituicao" class="hidden mt-1 text-sm text-red-500"></p>
            </div>

            <!-- Campos do Representante -->
            <div id="representanteFields" class="hidden">
                <div class="border-t pt-6" style="border-color: #d6d8de;">
                    <h3 class="text-lg font-semibold mb-4 text-primary">Dados do Representante</h3>
                </div>

                <!-- Nome Completo -->
                <div>
                    <label class="block text-sm font-semibold mb-2 text-primary">
                        Nome Completo <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="nomeCompleto" placeholder="Ex: Maria Silva Santos" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:outline-none">
                    <p id="errorNome" class="hidden mt-1 text-sm text-red-500"></p>
                </div>

                <!-- Cargo -->
                <div>
                    <label class="block text-sm font-semibold mb-2 text-primary">
                        Cargo <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="cargo" placeholder="Ex: Prefeito" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:outline-none">
                    <p id="errorCargo" class="hidden mt-1 text-sm text-red-500"></p>
                </div>

                <!-- CPF -->
                <div>
                    <label class="block text-sm font-semibold mb-2 text-primary">
                        CPF <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="cpf" placeholder="000.000.000-00" maxlength="14"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:outline-none">
                    <p id="errorCpf" class="hidden mt-1 text-sm text-red-500"></p>
                </div>

                <!-- E-mail -->
                <div>
                    <label class="block text-sm font-semibold mb-2 text-primary">
                        E-mail <span class="text-red-500">*</span>
                    </label>
                    <input type="email" id="email" placeholder="seu.email@exemplo.com"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:outline-none">
                    <p id="errorEmail" class="hidden mt-1 text-sm text-red-500"></p>
                </div>

                <!-- Checkbox LGPD -->
                <div class="border-t pt-4" style="border-color: #d6d8de;">
                    <label class="flex items-start gap-3 cursor-pointer">
                        <input type="checkbox" id="lgpdCheck" class="mt-1 w-5 h-5 rounded border-gray-300 text-primary focus:ring-2">
                        <span class="text-sm text-gray-700">
                            Declaro que li e concordo com o tratamento dos meus dados pessoais fornecidos para a Secretaria Estadual do Ambiente e Sustentabilidade - SEAS, com a finalidade de realizar a inscrição ao evento do ICMS Ecológico. <span class="text-red-500">*</span>
                        </span>
                    </label>
                    <p id="errorLgpd" class="hidden mt-2 text-sm text-red-500"></p>
                </div>

                <!-- Botão -->
                <button id="submitBtn" class="w-full text-white font-semibold py-3 px-6 rounded-lg transition duration-200 bg-primary hover:opacity-90 disabled:opacity-50 mt-4">
                    Realizar Inscrição
                </button>
            </div>
        </div>

        <!-- Aviso Final -->
        <div class="mt-6 p-4 rounded-lg bg-secondary">
            <p class="text-sm text-primary">
                <strong>Atenção:</strong> Os CPFs não podem ser repetidos. O e-mail pode ser compartilhado entre inscrições.
            </p>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwVua4iK963GJdEoltRnMWU2gNv8b9P4uglMeFwYErKwTzUTZLeOvjBEoBkxRQc1_Dx/exec';
        
        const municipios = ["Angra dos Reis", "Aperibé", "Araruama", "Areal", "Armação dos Búzios", "Arraial do Cabo", "Barra do Piraí", "Barra Mansa", "Belford Roxo", "Bom Jardim", "Bom Jesus do Itabapoana", "Cabo Frio", "Cachoeiras de Macacu", "Cambuci", "Carapebus", "Comendador Levy Gasparian", "Campos dos Goytacazes", "Cantagalo", "Cardoso Moreira", "Carmo", "Casimiro de Abreu", "Conceição de Macabu", "Cordeiro", "Duas Barras", "Duque de Caxias", "Engenheiro Paulo de Frontin", "Guapimirim", "Iguaba Grande", "Itaboraí", "Itaguaí", "Italva", "Itaocara", "Itaperuna", "Itatiaia", "Japeri", "Laje do Muriaé", "Macaé", "Macuco", "Magé", "Mangaratiba", "Maricá", "Mendes", "Mesquita", "Miguel Pereira", "Miracema", "Natividade", "Nilópolis", "Niterói", "Nova Friburgo", "Nova Iguaçu", "Paracambi", "Paraíba do Sul", "Paraty", "Paty do Alferes", "Petrópolis", "Pinheiral", "Piraí", "Porciúncula", "Porto Real", "Quatis", "Queimados", "Quissamã", "Resende", "Rio Bonito", "Rio Claro", "Rio das Flores", "Rio das Ostras", "Rio de Janeiro", "Santa Maria Madalena", "Santo Antônio de Pádua", "São Francisco de Itabapoana", "São Fidélis", "São Gonçalo", "São João da Barra", "São João de Meriti", "São José de Ubá", "São José do Vale do Rio Preto", "São Pedro da Aldeia", "São Sebastião do Alto", "Sapucaia", "Saquarema", "Seropédica", "Silva Jardim", "Sumidouro", "Tanguá", "Teresópolis", "Trajano de Moraes", "Três Rios", "Valença", "Varre-Sai", "Vassouras", "Volta Redonda"];
        
        let cpfsCadastrados = [];

        async function loadData() {
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                
                if (data.status === 'success') {
                    cpfsCadastrados = data.cpfs || [];
                }
                
                populateMunicipios();
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('formContainer').classList.remove('hidden');
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showError('Erro ao carregar formulário. Recarregue a página.');
            }
        }

        function populateMunicipios() {
            const select = document.getElementById('municipio');
            const instituicaoOption = select.querySelector('option[value="Instituição"]');
            
            municipios.forEach(mun => {
                const option = document.createElement('option');
                option.value = mun;
                option.textContent = mun;
                select.insertBefore(option, instituicaoOption);
            });
        }

        document.getElementById('cpf').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            }
            e.target.value = value;
        });

        document.getElementById('municipio').addEventListener('change', function() {
            const valor = this.value;
            const fields = document.getElementById('representanteFields');
            const campoInstituicao = document.getElementById('campoInstituicao');
            
            if (valor === 'Instituição') {
                campoInstituicao.classList.remove('hidden');
                fields.classList.remove('hidden');
            } else if (valor) {
                campoInstituicao.classList.add('hidden');
                document.getElementById('nomeInstituicao').value = '';
                fields.classList.remove('hidden');
            } else {
                campoInstituicao.classList.add('hidden');
                fields.classList.add('hidden');
            }
        });

        function validateCPF(cpf) {
            const numbers = cpf.replace(/\D/g, '');
            if (numbers.length !== 11 || /^(\d)\1{10}$/.test(numbers)) return false;
            
            let sum = 0;
            for (let i = 0; i < 9; i++) sum += parseInt(numbers.charAt(i)) * (10 - i);
            let digit = 11 - (sum % 11);
            if (digit >= 10) digit = 0;
            if (digit !== parseInt(numbers.charAt(9))) return false;
            
            sum = 0;
            for (let i = 0; i < 10; i++) sum += parseInt(numbers.charAt(i)) * (11 - i);
            digit = 11 - (sum % 11);
            if (digit >= 10) digit = 0;
            return digit === parseInt(numbers.charAt(10));
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        function showSuccess() {
            const successDiv = document.getElementById('successMessage');
            successDiv.classList.remove('hidden');
            setTimeout(() => successDiv.classList.add('hidden'), 5000);
        }

        document.getElementById('submitBtn').addEventListener('click', async function() {
            document.querySelectorAll('[id^="error"]').forEach(el => {
                el.classList.add('hidden');
                el.textContent = '';
            });

            const municipioSelecionado = document.getElementById('municipio').value;
            const nomeInstituicao = document.getElementById('nomeInstituicao').value.trim();
            const nomeCompleto = document.getElementById('nomeCompleto').value.trim();
            const cargo = document.getElementById('cargo').value.trim();
            const cpf = document.getElementById('cpf').value;
            const email = document.getElementById('email').value.trim();
            const lgpdCheck = document.getElementById('lgpdCheck').checked;

            let hasError = false;

            if (!municipioSelecionado) {
                document.getElementById('errorMunicipio').textContent = 'Selecione um município ou instituição';
                document.getElementById('errorMunicipio').classList.remove('hidden');
                hasError = true;
            }

            if (municipioSelecionado === 'Instituição' && !nomeInstituicao) {
                document.getElementById('errorInstituicao').textContent = 'Nome da instituição é obrigatório';
                document.getElementById('errorInstituicao').classList.remove('hidden');
                hasError = true;
            }

            if (!nomeCompleto) {
                document.getElementById('errorNome').textContent = 'Nome completo é obrigatório';
                document.getElementById('errorNome').classList.remove('hidden');
                hasError = true;
            }

            if (!cargo) {
                document.getElementById('errorCargo').textContent = 'Cargo é obrigatório';
                document.getElementById('errorCargo').classList.remove('hidden');
                hasError = true;
            }

            if (!validateCPF(cpf)) {
                document.getElementById('errorCpf').textContent = 'CPF inválido';
                document.getElementById('errorCpf').classList.remove('hidden');
                hasError = true;
            }

            const cpfNumeros = cpf.replace(/\D/g, '');
            if (cpfsCadastrados.includes(cpfNumeros)) {
                document.getElementById('errorCpf').textContent = 'Este CPF já foi cadastrado';
                document.getElementById('errorCpf').classList.remove('hidden');
                hasError = true;
            }

            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                document.getElementById('errorEmail').textContent = 'E-mail inválido';
                document.getElementById('errorEmail').classList.remove('hidden');
                hasError = true;
            }

            if (!lgpdCheck) {
                document.getElementById('errorLgpd').textContent = 'Você precisa concordar com o tratamento dos dados';
                document.getElementById('errorLgpd').classList.remove('hidden');
                hasError = true;
            }

            if (hasError) return;

            this.disabled = true;
            this.textContent = 'Enviando...';

            const municipioFinal = municipioSelecionado === 'Instituição' ? nomeInstituicao : municipioSelecionado;

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = SCRIPT_URL;
            form.target = 'hidden_iframe';
            
            const fields = { municipio: municipioFinal, nomeCompleto, cargo, cpf, email };
            for (const [key, value] of Object.entries(fields)) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                form.appendChild(input);
            }
            
            document.body.appendChild(form);
            
            let iframe = document.getElementById('hidden_iframe');
            if (!iframe) {
                iframe = document.createElement('iframe');
                iframe.id = 'hidden_iframe';
                iframe.name = 'hidden_iframe';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
            }
            
            iframe.onload = () => {
                showSuccess();
                document.getElementById('nomeCompleto').value = '';
                document.getElementById('cargo').value = '';
                document.getElementById('cpf').value = '';
                document.getElementById('email').value = '';
                document.getElementById('municipio').value = '';
                document.getElementById('nomeInstituicao').value = '';
                document.getElementById('lgpdCheck').checked = false;
                document.getElementById('campoInstituicao').classList.add('hidden');
                document.getElementById('representanteFields').classList.add('hidden');
                
                this.disabled = false;
                this.textContent = 'Realizar Inscrição';
                
                form.remove();
                loadData();
            };
            
            form.submit();
        });

        loadData();
    </script>
</body>
</html>
